<!DOCTYPE html>
<html>
	<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J69ENZY4TQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-J69ENZY4TQ');
    </script>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Do They Use</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
		<style type="text/css">
			.form-control {
				min-height: 32px;
				height: 0;
			}
			.form-select, .form-control {
				cursor: pointer;
        line-height: 1.1;
			}
			.resize-canvas-wrapper {
				width: 100px !important; /* https://stackoverflow.com/questions/42340342/cant-make-chart-js-responsive */
			}
			.look-like-link {
				text-decoration: underline;
				color: rgba(var(--bs-link-color-rgb),var(--bs-link-opacity,1));
				cursor: pointer;
			}
			.look-like-link:hover {
				--bs-link-color-rgb: var(--bs-link-hover-color-rgb);
			}
			.no-margin-bottom {
				margin-bottom: 0!important;
			}
			.time-shortcut {
				margin-left: 5px;
				font-size: 14px;
			}
			.custom-label {
				font-weight: bold;
				font-size: 14px;
				color: gray;
			}
			.custom-helper {
				font-size: 14px;
				color: gray;
        margin-top: 5px;
			}
      .refresh_reset_buttons {
        padding-top: 25px;
        margin-bottom: 1rem;
      }
      @media screen and (max-width: 992px) {
          .refresh_reset_buttons {
          padding-top: 0;
        }
      }
      .hidden {
        display: none;
      }
      .canvas-wrapper {
        width: 100%;
        border: 1px solid #dee2e6;
      }
      .container-padding {
        padding: 5px;
      }
      .active-filter {
        background-color: mediumseagreen;
        padding: 3px 7px 5px 7px;
        border-radius: 4px;
        color: white;
      }
		</style>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row container-padding">
        <div class="row">
          <div class="col-lg-2">
            <label for="topic" class="form-label no-margin-bottom custom-label">topic:</label>
            <select class="form-control form-select" data-dtu="topic" id="drpd:topic">
              <option>auto-generated (light)</option>
              <option>auto-generated (heavy)</option>
              <option>real usage</option>
            </select>
          </div>
        
					<div class="col-lg">
            <div class="row">
              <div class="col-sm">
                <label for="datetime_from" class="form-label no-margin-bottom custom-label">date-time from:</label>
    		        <input id="datetime_from" class="form-control" type="datetime-local" data-dtu="date-time from"/>
              </div>
              <div class="col-sm">
                <label for="datetime_to" class="form-label no-margin-bottom custom-label">date-time to:</label>
  		          <input id="datetime_to" class="form-control" type="datetime-local" data-dtu="date-time to"/>
              </div>
  		      
    		      <p class="custom-helper">Show last: 
                <span class="time-shortcut look-like-link" timedelta_ms="60000" data-dtu="1 min">1 min</span>
    		      	<span class="time-shortcut look-like-link" timedelta_ms="900000" data-dtu="15 min">15 min</span>
    		      	<span class="time-shortcut look-like-link" timedelta_ms="3600000" data-dtu="1 hour">1 hour</span>
                <span class="time-shortcut look-like-link" timedelta_ms="7200000" data-dtu="2 hour">2 hour</span>
                <span class="time-shortcut look-like-link" timedelta_ms="43200000" data-dtu="12 hour">12 hour</span>
    		      	<span class="time-shortcut look-like-link" timedelta_ms="86400000" data-dtu="24 hours">24 hours</span>
                <span class="time-shortcut look-like-link" timedelta_ms="259200000" data-dtu="3 days">3 days</span>
    		      	<span class="time-shortcut look-like-link" timedelta_ms="604800000" data-dtu="7 days">7 days</span>
                <span class="time-shortcut look-like-link" timedelta_ms="1209600000" data-dtu="14 days">14 days</span>
                <span class="time-shortcut look-like-link" timedelta_ms="1728000000" data-dtu="20 days">20 days</span>
    		      	<span class="time-shortcut look-like-link" timedelta_ms="2592000000" data-dtu="30 days">30 days</span>
    		      	<span class="time-shortcut look-like-link" timedelta_ms="8640000000" data-dtu="100 days">100 days</span>
                <span class="time-shortcut look-like-link" timedelta_ms="31536000000" data-dtu="365 days">365 days</span>
                <span class="time-shortcut look-like-link" timedelta_ms="63072000000" data-dtu="2 years">2 years</span>
                <span class="time-shortcut look-like-link" timedelta_ms="86400000000" data-dtu="1000 days">1000 days</span>
    		    	</p>
            </div>
          </div>

  		    <div class="col-lg-3 refresh_reset_buttons">
  		    	<button id="btn:refresh_features_page_data_according_to_filters_setup" type="button" class="btn btn-primary btn-sm" data-dtu="apply filter">Apply filter</button>
  		    	<button id="btn:reset_features_page_filters" type="button" class="btn btn-secondary btn-sm" data-dtu="reset filter">Reset filter</button>
  		    </div>
  			</div>

  			<div class="row">
          <div class="col-lg">
            <h4>Elements usage stats for:</h4>
            <p id="feature_path" path='[""]'></p>
            <div class="canvas-wrapper">
              <canvas id="features_calls_over_time_chart_id"></canvas>
            </div>
          </div>
        </div>
  		</div>
    </div>

		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
		<script> // https://stackoverflow.com/questions/40297763/how-to-disable-google-analytics-on-localhost
      if (window.location.hostname == '') { // local file
        window['ga-disable-UA-G-J69ENZY4TQ'] = true;
      }
	////////////////////// DB /////////////////////////
			// separate tables in db
			var db = [];
			var db_tags = {};

			// INIT DB DATA:
			db2 = [
				{"gtag":"ABCD","date_time":1671532440488,"uid":52,"feature_path":["Posts","Multiple media objects","Videos"],"feature":"Videos","topic":"default"},
			]
	////////////////////// END OF DB /////////////////////////


	////////////////////// RX_API /////////////////////////
			function DB_INSERT_report(r) {
				debug_helper(arguments, DEBUG);

				if (!r.topic) // enrich
					r.topic = "default";
        if (!r.feature_path) // enrich
          r.feature_path = [''];
				if (r.feature_path[0] !== '')
				  r.feature_path.unshift(''); // add to the beginning as "all" features for filter

				db.push(r);
			}

			function DB_UPDATE_tags(r) {
				debug_helper(arguments, DEBUG);

				if (!db_tags[r.gtag]) {
					let topic = r.topic;
					db_tags[r.gtag] = {topic: r.tags};
				}
				else {
					if (!db_tags[r.gtag][r.topic]) {
						db_tags[r.gtag][r.topic] = r.tags;
					}
					else {
						let already_saved_tags = db_tags[r.gtag][r.topic];
						for (let tag in r.tags) {
							let value = r.tags[tag][0]; // support multiselect here
							if (tag in already_saved_tags) {
								if (already_saved_tags[tag].includes(value))
									continue;
								already_saved_tags[tag].push(value);
							}
							else {
								already_saved_tags[tag] = [r.tags[tag]];
							}
						}
					}
				}
			}

			function RX_API_save_to_db(r) {
				debug_helper(arguments, DEBUG);

				DB_INSERT_report(r);
				DB_UPDATE_tags(r);
			}

			function RX_API_submint_report(report) {
				debug_helper(arguments, DEBUG);
				let r = JSON.parse(report);
				RX_API_save_to_db(r);
				//ANALYTICS_PORTAL_SDK_refresh_features_page_data_according_to_user_filters_setup(); // temporary for debug
			}
	////////////////// END OF RX_API ///////////////////////


	////////////////////// ANALYTICS_PORTAL_SDK /////////////////////////
			const ctag = "ABCD"; // somehow via session ID mapping in DB, not in request

      function ANALYTICS_PORTAL_SDK_get_chart_size(chart_id) {
        debug_helper(arguments, DEBUG);

        const chart = Chart.getChart(chart_id);
        let chart_width_px = chart.canvas.style.width; // Math.floor(chart.chartArea.width); - not work due to constant recalcs, so, base on canvas.style.width
        chart_width_px = chart_width_px.slice(0, chart_width_px.length - 2); // cut 'px'
        return parseInt(chart_width_px);
      }

			function ANALYTICS_PORTAL_SDK_reset_datetime_filter() {
				debug_helper(arguments, DEBUG);
				ANALYTICS_PORTAL_SDK_set_datetime_filter();
			}

      function ANALYTICS_PORTAL_SDK_format_date_time_for_filter(date_time) {
        debug_helper(arguments, DEBUG);

        date = new Date(date_time).toLocaleDateString('en-GB').split('/');
        time = new Date(date_time).toLocaleTimeString('en-GB');
        return date[2] + '-' + date[1] + '-' + date[0] + 'T' + time;
      }

			function ANALYTICS_PORTAL_SDK_set_datetime_filter(timedelta_ms) {
				debug_helper(arguments, DEBUG);

				let datetime_to = "";
				let datetime_from = "";
				if (timedelta_ms) { // if not reset
          const now = new Date();
					const back = now - timedelta_ms;
          datetime_from = ANALYTICS_PORTAL_SDK_format_date_time_for_filter(back);
          datetime_to = ANALYTICS_PORTAL_SDK_format_date_time_for_filter(now);
				}

				const datetime_to_input = document.getElementById('datetime_to');
				const datetime_from_input = document.getElementById('datetime_from');
				datetime_to_input.value = datetime_to;
				datetime_from_input.value = datetime_from;
			}

			function ANALYTICS_PORTAL_SDK_init_time_shortcut_listeners() {
				debug_helper(arguments, DEBUG);

				const elements_to_track = document.querySelectorAll('.time-shortcut');
				for (let i = 0; i < elements_to_track.length; i++) {
					let el = elements_to_track[i];
					el.addEventListener("click", function(e) {
            ANALYTICS_PORTAL_SDK_remove_all_active_filter_class_from_time_shortcuts();
            this.classList.add('active-filter');
						const timedelta_ms = this.getAttribute('timedelta_ms');
						ANALYTICS_PORTAL_SDK_set_datetime_filter(timedelta_ms);
						ANALYTICS_PORTAL_SDK_refresh_features_page_data_according_to_user_filters_setup();
					}, false);
				}
			}

      function ANALYTICS_PORTAL_SDK_remove_all_active_filter_class_from_time_shortcuts() {
        const elements_to_track = document.querySelectorAll('.time-shortcut');
        for (let i in elements_to_track) {
          let el = elements_to_track[i];
          if (el.classList)
            el.classList.remove('active-filter')
        }
      }

			function ANALYTICS_PORTAL_SDK_collect_user_filters_on_the_page() {
				debug_helper(arguments, DEBUG);

        //let topic = window.localStorage.getItem('topic');
        //if (!topic)
				  topic = document.getElementById('drpd:topic').value;
        //else
          document.getElementById('drpd:topic').value = topic;

				let user_filters = {"ctag": ctag, "topic": topic};

				const df = document.getElementById("datetime_from").value;
				if (df != '')
					user_filters["datetime_from"] = Date.parse(df);

				const dt = document.getElementById("datetime_to").value;
				if (dt != '')
					user_filters["datetime_to"] = Date.parse(dt);

				let feature_path = document.getElementById("feature_path").getAttribute("path");
				user_filters["feature_path"] = JSON.parse(feature_path);

				return user_filters;
			}

			async function ANALYTICS_PORTAL_SDK_start() {
				debug_helper(arguments, DEBUG);

				// detect which tab now is opened and update accordingly
				ANALYTICS_PORTAL_SDK_init_calls_over_time_chart_for_('features_calls_over_time_chart_id');
				ANALYTICS_PORTAL_SDK_init_time_shortcut_listeners();

				await ANALYTICS_PORTAL_SDK_refresh_features_page_data_according_to_user_filters_setup();

				// add listeners
				ANALYTICS_PORTAL_SDK_make_refresh_button_work();
				ANALYTICS_PORTAL_SDK_make_reset_filters_button_work();
        ANALYTICS_PORTAL_SDK_make_reset_active_time_filters_work();
        ANALYTICS_PORTAL_SDK_make_topic_dropdown_work();
			}

      function ANALYTICS_PORTAL_SDK_make_topic_dropdown_work() {
        debug_helper(arguments, DEBUG);

        let btn = document.getElementById('drpd:topic');
        btn.addEventListener("change", function(e) {
          ANALYTICS_PORTAL_SDK_refresh_features_page_data_according_to_topic_change();
        })
      }

			function ANALYTICS_PORTAL_SDK_make_refresh_button_work() {
				debug_helper(arguments, DEBUG);

				let btn = document.getElementById('btn:refresh_features_page_data_according_to_filters_setup');
				btn.addEventListener("click", function(e) {
					ANALYTICS_PORTAL_SDK_refresh_features_page_data_according_to_user_filters_setup();
				})
			}

			function ANALYTICS_PORTAL_SDK_make_reset_filters_button_work() {
				debug_helper(arguments, DEBUG);

				let btn = document.getElementById('btn:reset_features_page_filters');
				btn.addEventListener("click", function(e) {
          ANALYTICS_PORTAL_SDK_remove_all_active_filter_class_from_time_shortcuts();
					ANALYTICS_PORTAL_SDK_reset_filters_on_features_page();
				})
			}

      function ANALYTICS_PORTAL_SDK_make_reset_active_time_filters_work() {
        debug_helper(arguments, DEBUG);

        const from = document.getElementById('datetime_from');
        from.addEventListener("change", function(e) {
          ANALYTICS_PORTAL_SDK_remove_all_active_filter_class_from_time_shortcuts();
        });

        const to = document.getElementById('datetime_to');
        to.addEventListener("change", function(e) {
          ANALYTICS_PORTAL_SDK_remove_all_active_filter_class_from_time_shortcuts();
        });
      }

		  function ANALYTICS_PORTAL_SDK_init_calls_over_time_chart_for_(chart_id) {
				debug_helper(arguments, DEBUG);
		  	const config = {
				  type: 'line',
				  data: {
					  datasets: [{
  	    				borderWidth: 1,
                tension: 0.2,
                fill: false
  					  },
              {
                borderWidth: 1,
                tension: 0.2,
                borderColor: '#058dc7',
                //borderColor: '#777777',
                //backgroundColor: '#e7f4f988',
                backgroundColor: '#f6f6b788',
                fill: '-1',
              },
              {
                borderWidth: 1,
                tension: 0.2,
                //backgroundColor: '#e7f4f999',
                backgroundColor: '#f6f6b788',
                fill: '-1'
              }
            ]
					},
				  options: {
            elements: {
              line: {
                fill: false
              },
              point: {
                radius: 0,
              },
            },
				  	scales: {
				      y: {
                //display: false,
                min: 0,
				      	title: {
				      		display: false,
				      	},
					    },
					    x: {
					    	type: 'time',
					    	time: {
					    		//unit: 'minute',
					    		displayFormats: {
					    			second: 'HH:mm:ss',
                    minute: 'HH:mm',
                    hour: 'HH:mm',
                  }
					    	},
					    	title: {
				      		display: false,
				      		text: "time",	
				      	},
					    	ticks: {
                  display: true,
                  crossAlign: 'far'
                  //source: 'data',
            			//stepSize: 1,
          			}
					    },
						},
				    responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 1,
            layout: {
              //autoPadding: false,
              //padding: 100
            },
				    plugins: {
              legend: {
				        display: false,
				        position: "right",
				        maxWidth: 1000,
				        labels: {
				        	boxWidth: 12,
				        	boxHeight: 12,
				        	padding: 8,
				        	usePointStyle: true,
				        }
				      },
				      title: {
				        display: true,
				      },
				      tooltip: {
				        callbacks: {
				          label: function(context) {
				            return context.dataset.label;
				          }
				        }
				      },
				    }
				  },
          plugins: [{
            afterDraw: function(chart) { // https://stackoverflow.com/questions/55564508/pie-chart-js-display-a-no-data-held-message
              try {
                if (chart.data.datasets[0].data.length == 0) {
                  ANALYTICS_PORTAL_SDK_display_message_on_chart(chart, 'No data to display for current filter condition(s)');
                }
              } 
              catch (error) {
                let message = 'An error occured while trying to draw the chart'
                ANALYTICS_PORTAL_SDK_display_message_on_chart(chart, message);
              }
            },
          }]
				};
			  
			  if ('features_calls_over_time_chart_id' == chart_id) {
			  	config.options.scales.y.title.text = "# of calls for selected element(s) at the same time";
			  	config.options.plugins.title.text = "Median calls (with max and min bursts) for the selected element in time";
			  }
        //config.options.animations = false;

        const chart_element = document.getElementById(chart_id);
			  new Chart(chart_element, config);   
		  }

      function ANALYTICS_PORTAL_SDK_display_message_on_chart(chart, message) {
        let ctx = chart.ctx;
        chart.clear();
        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = "14px Arial";
        ctx.fillText(message, chart.width / 2, chart.height / 2);
        ctx.restore();
      }

			function ANALYTICS_PORTAL_SDK_update_feature_path(feature) {
				debug_helper(arguments, DEBUG);
				let feature_path_element = document.getElementById("feature_path");
				let current_feature_path = feature_path_element.getAttribute("path");
				
				new_feature_path = JSON.parse(current_feature_path);
				new_feature_path.push(feature);
				new_feature_path = JSON.stringify(new_feature_path);
				feature_path_element.setAttribute("path", new_feature_path);
			}

			function ANALYTICS_PORTAL_SDK_refresh_calls_over_time_for_chart_id_(chart_id, user_filters, kwargs) {
				debug_helper(arguments, DEBUG); 

        const chart_width_px = ANALYTICS_PORTAL_SDK_get_chart_size(chart_id);
				const reports_match_user_filters_length = kwargs['reports_match_user_filters_length'];
				let config = {};
				if (reports_match_user_filters_length == 0)
					config = {'labels': [], 'data': [], 'unit': 'second', 'step_size': 1}; // no data case
				else
					config = TX_API_get_data_for_chart_(chart_width_px, user_filters, kwargs);					

		  	let chart = Chart.getChart(chart_id);
		  	chart.config.data.labels = config.labels;

		  	chart.config.data.datasets[0].data = config.data[0];
        chart.config.data.datasets[1].data = config.data[1];
        chart.config.data.datasets[2].data = config.data[2];
		  	chart.config.options.scales.x.time.unit = config.unit;
		  	chart.config.options.scales.x.ticks.stepSize = config.step_size;
		  	//console.log("sec in 1 px: ", config.ms_in_pixel / 1000)
				chart.update();

        ANALYTICS_PORTAL_SDK_refresh_stats_for_chart_id_(chart_id, config);
			}

      function ANALYTICS_PORTAL_SDK_refresh_stats_for_chart_id_(chart_id, config) {
        ; // here
      }

			function ANALYTICS_PORTAL_SDK_reset_filters_on_features_page() {
				debug_helper(arguments, DEBUG);

				ANALYTICS_PORTAL_SDK_reset_datetime_filter();
				ANALYTICS_PORTAL_SDK_refresh_features_page_data_according_to_user_filters_setup();
			}

			function ANALYTICS_PORTAL_SDK_refresh_features_page_data_according_to_topic_change() {
				debug_helper(arguments, DEBUG);

        // remember value
        const topic = document.getElementById('drpd:topic').value;
        window.localStorage.setItem('topic', topic);
				ANALYTICS_PORTAL_SDK_refresh_features_page_data_according_to_user_filters_setup();
			}

			function ANALYTICS_PORTAL_SDK_refresh_features_page_data_according_to_user_filters_setup() {
				debug_helper(arguments, DEBUG);

				let user_filters = ANALYTICS_PORTAL_SDK_collect_user_filters_on_the_page();
				let kwargs = TX_API_process_user_filters_request(user_filters);

				ANALYTICS_PORTAL_SDK_refresh_feature_path(user_filters, kwargs);
				ANALYTICS_PORTAL_SDK_refresh_calls_over_time_for_chart_id_('features_calls_over_time_chart_id', user_filters, kwargs);
			}

			function ANALYTICS_PORTAL_SDK_refresh_feature_path(user_filters, kwargs) {
				debug_helper(arguments, DEBUG);

        const elements = ANALYTICS_PORTAL_SDK_get_elements_in_reports(kwargs);
				let feature_path_element = document.getElementById("feature_path");
				let feature_path = user_filters.feature_path;
        //console.log(elements)

        let feature_path_html = '<select class="form-control form-select" disabled><option>all the elements</option></select>'
				feature_path_element.innerHTML = feature_path_html;
			}

      function ANALYTICS_PORTAL_SDK_get_elements_in_reports(kwargs) {
        debug_helper(arguments, DEBUG);

        // TODO: not in reports, but overall.
        let elements = [''];
        const reports_match_user_filters = kwargs['reports_match_user_filters'];
        for (let i in reports_match_user_filters) {
          let r = reports_match_user_filters[i];
          if (!elements.includes(r.feature))
            elements.push(r.feature);
        }
        return elements;
      }

      /*
			function ANALYTICS_PORTAL_SDK_feature_path_click(element) {
				let new_feature_path = element.getAttribute("path");
				document.getElementById("feature_path").setAttribute("path", new_feature_path);
				ANALYTICS_PORTAL_SDK_refresh_features_page_data_according_to_user_filters_setup();
			}
      */
	////////////////////// END OF ANALYTICS_PORTAL_SDK /////////////////////////

	////////////////////// TX API /////////////////////////
			function TX_API_get_all_from_db() {  // debug func
				debug_helper(arguments, DEBUG);
				for(var i = 0; i < db.length; i++) {
					console.log(JSON.stringify(db[i]));
				}
			}

			/*
			function TX_API_sum_values_of_dict(obj) { // https://stackoverflow.com/questions/16449295/how-to-sum-the-values-of-a-javascript-object
  			return Object.values(obj).reduce((a, b) => a + b, 0);
			}
			*/

			function TX_API_get_sum(list_sorted_by_value_desc) {
				debug_helper(arguments, DEBUG);

				let sum = 0;
				for (let i in list_sorted_by_value_desc)
					sum += list_sorted_by_value_desc[i];

				return sum;
			}

			function TX_API_get_avg(list_sorted_by_value_desc) {
				debug_helper(arguments, DEBUG);

				let items_number = list_sorted_by_value_desc.length;
				const sum = TX_API_get_sum(list_sorted_by_value_desc);
				return sum / items_number;
			}

			function TX_API_get_median(list_sorted_by_value_desc) {
				debug_helper(arguments, DEBUG);

				const items_number = list_sorted_by_value_desc.length;
				const middle_item_id = Math.floor(items_number / 2); // floor because arr ids count from 0, not 1
				const middle_item_value = list_sorted_by_value_desc[middle_item_id];
				if (items_number % 2 != 0) // if odd
					return middle_item_value;

				const another_middle_item_id = middle_item_id + 1; // next because was floor
				const another_middle_item_value = list_sorted_by_value_desc[another_middle_item_id];
				return (middle_item_value + another_middle_item_value) / 2;
			}

			function TX_API_get_mode(list_sorted_by_value_desc) {
				debug_helper(arguments, DEBUG);

				let arr = list_sorted_by_value_desc;
		    return arr.sort((a,b) => // https://stackoverflow.com/questions/1053843/get-the-element-with-the-highest-occurrence-in-an-array
    	      arr.filter(v => v===a).length
      	  - arr.filter(v => v===b).length
    		).pop();
			}

			function TX_API_get_range(list_sorted_by_value_desc) {
				debug_helper(arguments, DEBUG);

				const max = TX_API_get_max(list_sorted_by_value_desc);
				const min = TX_API_get_min(list_sorted_by_value_desc);
				return max - min;
			}

      function TX_API_get_min(list_sorted_by_value_desc) {
        debug_helper(arguments, DEBUG);
        return list_sorted_by_value_desc[list_sorted_by_value_desc.length - 1];
      }

      function TX_API_get_max(list_sorted_by_value_desc) {
        debug_helper(arguments, DEBUG);
        return list_sorted_by_value_desc[0];
      }

			function TX_API_get_stats_for_list(list) {
				debug_helper(arguments, DEBUG);

        const list_sorted_by_value_desc = list.sort(function(a, b){return b - a})
        //console.log(list_sorted_by_value_desc)

        const min = TX_API_get_min(list_sorted_by_value_desc);
        const max = TX_API_get_max(list_sorted_by_value_desc);
				const avg = TX_API_get_avg(list_sorted_by_value_desc);
				const median = TX_API_get_median(list_sorted_by_value_desc);
				const mode = TX_API_get_mode(list_sorted_by_value_desc);
				const range = TX_API_get_range(list_sorted_by_value_desc);

				return {'avg': avg, 'median': median, 'mode': mode, 'range': range, 'min': min, 'max': max};
			}

			function TX_API_process_user_filters_request(user_filters) {
				debug_helper(arguments, DEBUG);

				let kwargs = {};

				const reports_match_user_filters  = DB_SELECT_all_WHERE_user_filters(user_filters);
				kwargs['reports_match_user_filters'] = reports_match_user_filters;
				kwargs['reports_match_user_filters_length'] = reports_match_user_filters.length;

				//console.log(kwargs)
				return kwargs;
			}

			function DB_SELECT_EMULATION_check_if_report_ctag_and_topic_match_them_in_user_filters(r, user_filters) {
				debug_helper(arguments, DEBUG);
				let ctag = user_filters['ctag']
				let topic = user_filters['topic']

				if (r.ctag != ctag)
					return false;

				if (r.topic != topic)
					return false;

				return true;
			}

			function DB_SELECT_EMULATION_check_if_report_date_matches_dates_in_user_filters(r, user_filters) {
				debug_helper(arguments, DEBUG);
				let datetime_from = user_filters['datetime_from'];
				let datetime_to = user_filters['datetime_to'];
				
				if (!datetime_from && !datetime_to) {
					return true;
				}
				if (!datetime_from && datetime_to) {
					if (r.date_time > datetime_to) {
						return false;
					}
				}
				if (datetime_from && !datetime_to) {
					if (r.date_time < datetime_from) {
						return false;
					}
				}
				if (datetime_from && datetime_to) {
					if (r.date_time > datetime_to || r.date_time < datetime_from) {
						return false;
					}
				}

				return true;
			}

			function DB_SELECT_EMULATION_check_if_report_uid_matches_uids_in_user_filters(r, user_filters) {
				debug_helper(arguments, DEBUG);
				let uids = user_filters['uids'];
				let uids_exclude = user_filters['uids_exclude'];

				if (uids) {
					if (!uids.includes(String(r.uid))) {
						return false;
					}
				}
				if (uids_exclude) {
					if (uids_exclude.includes(String(r.uid))) {
						return false;
					}
				}

				return true;
			}

			function DB_SELECT_EMULATION_check_if_report_ctag_topic_users_dates_match_user_filters(r, user_filters) {
				debug_helper(arguments, DEBUG);
				if (!DB_SELECT_EMULATION_check_if_report_uid_matches_uids_in_user_filters(r, user_filters))
					return false;

				if (!DB_SELECT_EMULATION_check_if_report_ctag_and_topic_match_them_in_user_filters(r, user_filters))
					return false;

				if (!DB_SELECT_EMULATION_check_if_report_date_matches_dates_in_user_filters(r, user_filters))
					return false;

				return true;
			}

			function DB_SELECT_all_WHERE_user_filters(user_filters) {
				// SELECT * FROM reports_table WHERE 1=1
				// AND ctag = user_filters.ctag
				// AND topic = user_filters.topic
				// AND uid IN user_filters.uids_to_include
				// AND uid NOT IN user_filters.uids_to_exclude
				// AND date_time BETWEEN (user_filters.date_time_from, user_filters.date_time_to)
				// AND FOR each_custom_tag DO each_custom_tag = user_filters.custom_tag;
				debug_helper(arguments, DEBUG);

				var found = [];
				for (let i = 0; i < db.length; i++) {
					var r = db[i];
					if (!DB_SELECT_EMULATION_check_if_report_ctag_topic_users_dates_match_user_filters(r, user_filters))
						continue;
					found.push(r);
				}
				return found;
			}

			const TX_API_arrays_are_equal = (a, b) => // https://www.freecodecamp.org/news/how-to-compare-arrays-in-javascript/
  			a.length === b.length && a.every((element, index) => element === b[index]);

			function TX_API_get_dates_from_to(user_filters, kwargs) {
				debug_helper(arguments, DEBUG);

				const reports_match_user_filters_length = kwargs['reports_match_user_filters_length'];
				let datetime_from = user_filters['datetime_from'];
				let datetime_to = user_filters['datetime_to'];
				if (!datetime_to)
					datetime_to = Date.now(); // if not set then till now

				if (reports_match_user_filters_length == 0) {
					if (!datetime_from)
						datetime_from = Date.now();

					let time_range = datetime_to - datetime_from;
					return {'datetime_from': datetime_from, 'datetime_to': datetime_to, 'time_range': time_range};
				}

				const reports_match_user_filters = kwargs['reports_match_user_filters'];
				if (!datetime_from)
					datetime_from = reports_match_user_filters[0].date_time; // if not set then from first date in all related reports

				let time_range = datetime_to - datetime_from;
				return {'datetime_from': datetime_from, 'datetime_to': datetime_to, 'time_range': time_range};
			}

			function TX_API_get_ms_in_1_px(chart_width_px, displayed_time_range) {
				debug_helper(arguments, DEBUG);

        return Math.floor(displayed_time_range / chart_width_px); // how many milliseconds in 1 px
			}

      const CHART_SIZE = {'xs': 500, 's': 800, 'm': 1000, 'l': 1200}; // https://getbootstrap.com/docs/4.1/layout/grid/
      const UNITS_NAMES = [ // https://www.chartjs.org/docs/latest/axes/cartesian/time.html#time-units
        'second',
        'minute',
        'hour',
        'day',
        //'week', // don't want weeks
        'month',
        //'quarter', // don't want quarters
        'year'
      ];
      const UNITS_NAMES_VALUES = {
        'second': 10**3,
        'minute': 60 * 10**3,
        'hour': 60 * 60 * 10**3,
        'day': 24 * 60 * 60 * 10**3,
        // 'week': 7 * 24 * 60 * 60 * 10**3, // don't want weeks
        'month': 30 * 24 * 60 * 60 * 10**3,
        // 'quarter': 3 * 30 * 24 * 60 * 60 * 10**3, // don't want quarters
        'year': 365 * 24 * 60 * 60 * 10**3
      };
      
			function TX_API_get_display_unit_and_step(displayed_time_range, chart_width_px) {
				debug_helper(arguments, DEBUG);
        
        // CHART_SIZE.l and higher
        let min_pixels_for_tick = 100;
        let max_pixels_for_tick = 200;

        if (chart_width_px <= CHART_SIZE.xs) {
          min_pixels_for_tick = 50;
          max_pixels_for_tick = 150;
        }
        else if (chart_width_px <= CHART_SIZE.s) {
          min_pixels_for_tick = 80;
          max_pixels_for_tick = 160;
        }
        else if (chart_width_px <= CHART_SIZE.m) {
          min_pixels_for_tick = 90;
          max_pixels_for_tick = 180;
        }
        
        // has to be sorted - that's why list, but not dict
        const units_names = [...UNITS_NAMES].reverse(); // to go from largest to lowest to detect first > 0
        const units_values = [];
        for (let i in units_names) {
          let unit = units_names[i];
          units_values.push(UNITS_NAMES_VALUES[unit]);
        } // due to reverse of units_names this appears reverse automatically

				if (0 == displayed_time_range) { // artificial case of 0 seconds
          return {'unit': 'second', 'step_size': 1};
        }

        preferred_steps_for_units = {
          'year': [1, 2, 5, 10], 
          'month': [1, 2, 3, 6, 12], 
          'day': [1, 2, 3, 7, 10], 
          'hour': [1, 2, 3, 6, 12, 24], 
          'minute': [1, 2, 3, 5, 10, 12, 15, 20, 30, 60], 
          'second': [1, 2, 3, 5, 10, 12, 15, 20, 30, 60]
        };
        let min_steps = Math.floor(chart_width_px / max_pixels_for_tick);
        let max_steps = Math.floor(chart_width_px / min_pixels_for_tick);
        //console.log(min_steps, max_steps)

        let unit = 'second';
        let step_size = 1;

        for (let i in units_values) {
          let em = displayed_time_range / units_values[i]; // how many each of them in this time range
          let em_min = Math.floor(em / max_steps); // how many items in one step for min steps case
          let em_max = Math.floor(em / min_steps); // how many items in one step for max steps case

          //console.log(units_names[i], em, em_min, em_max);
        }
        for (let i in units_values) {
          let em = displayed_time_range / units_values[i]; // how many each of them in this time range
          let em_min = Math.floor(em / max_steps); // how many items in one step for min steps case
          let em_max = Math.floor(em / min_steps); // how many items in one step for max steps case

          if (em_min + 1 > 0 && em_max > 0) {
            unit = units_names[i];
            let preferred_steps_for_this_unit = preferred_steps_for_units[unit];
            for (let j in preferred_steps_for_this_unit) {
              let candidate = preferred_steps_for_this_unit[j];
              if (candidate >= em_min && candidate <= em_max) {
                  if (em / candidate <= max_steps && em / candidate >= min_steps) {
                    step_size = candidate;
                    break;
                  }
              }
              step_size = em_min;
            }
            break;
          }
        }

        //console.log(chart_width_px, unit, step_size);        
        return {'unit': unit, 'step_size': step_size};
			}

			function TX_API_prepare_time_windows_agregations(chart_width_px, user_filters, kwargs) {
				debug_helper(arguments, DEBUG);

				let dates = TX_API_get_dates_from_to(user_filters, kwargs)
				let ms_in_1_px = TX_API_get_ms_in_1_px(chart_width_px, dates.time_range);

				let agregation_result = [];
				if (ms_in_1_px > 0) {
					if (dates.datetime_from != dates.datetime_to) {
						for (let t = dates.datetime_to - ms_in_1_px; // from "datetime_to -" to make most recent window always available
                     t >= dates.datetime_from + ms_in_1_px * 1; // till "datetime_from +" - to not to include oldest partial frame data
                     t -= ms_in_1_px) {
							agregation_result.push(t);
						}
					}
					else
						agregation_result.push(dates.datetime_from);
				}

        //console.log(new Date(dates.datetime_from))
        //console.log(new Date(dates.datetime_to))
        //console.log(dates.time_range, ms_in_1_px)

				return {'agregation_result': agregation_result.reverse(), 
                'displayed_time_range': dates.time_range, 
                'datetime_from': dates.datetime_from, 
                'datetime_to': dates.datetime_to, 
                'ms_in_1_px': ms_in_1_px};
			}

			function TX_API_get_reports_with_features_path_match(user_filters, kwargs) {
				debug_helper(arguments, DEBUG);
				let reports_with_matched_feature_paths = [];

				const feature_path_user_filters = user_filters['feature_path'];
				const feature_path_user_filters_length = feature_path_user_filters.length;
				const reports_match_user_filters = kwargs['reports_match_user_filters'];
				const reports_match_user_filters_length = kwargs['reports_match_user_filters_length'];

				for (let i = 0; i < reports_match_user_filters_length; i++) {
					let report = reports_match_user_filters[i];
					let reports_match = true;
					if (!(feature_path_user_filters_length == 1 && feature_path_user_filters[0] == '')) { // if not [""]
						for (let j = 0; j < feature_path_user_filters_length; j++) {
							if (report.feature_path[j] != feature_path_user_filters[j]) {
								reports_match = false;
								break;
							}
						}
					}

					if (reports_match)
						reports_with_matched_feature_paths.push(report);
				}
				return reports_with_matched_feature_paths;
			}

      function TX_API_get_optimal_time_step_for_agregations(chart_width_px, ms_in_1_px) {
        let step = 10;

        const AGREGATION_TRESHOLDS = {
          'xs': UNITS_NAMES_VALUES.second * 25,
          's':  UNITS_NAMES_VALUES.minute * 10,
          'm':  UNITS_NAMES_VALUES.minute * 25,
          'l':  UNITS_NAMES_VALUES.day * 1,
        };

        if (chart_width_px <= CHART_SIZE.xs) {
          if (ms_in_1_px <= AGREGATION_TRESHOLDS.xs)
            step = 1;
          else if (ms_in_1_px <= AGREGATION_TRESHOLDS.s)
            step = 4;
          else if (ms_in_1_px <= AGREGATION_TRESHOLDS.m)
            step = 5;
          else if (ms_in_1_px <= AGREGATION_TRESHOLDS.l)
            step = 7;
        }
        else if (chart_width_px <= CHART_SIZE.s) {
          step = 1;
        }
        else if (chart_width_px <= CHART_SIZE.m) {
          if (ms_in_1_px <= AGREGATION_TRESHOLDS.xs)
            step = 1;
          else if (ms_in_1_px <= AGREGATION_TRESHOLDS.s)
            step = 4;
          else if (ms_in_1_px <= AGREGATION_TRESHOLDS.m)
            step = 5;
          else if (ms_in_1_px <= AGREGATION_TRESHOLDS.l)
            step = 7;
        }
        
        for (key in UNITS_NAMES_VALUES) {
          console.log(key, ms_in_1_px / UNITS_NAMES_VALUES[key]);
        }
        console.log('chart_width_px:', chart_width_px, 'ms_in_1_px:', ms_in_1_px, 'step:', step);
        return step;
      }

			function TX_API_get_data_for_chart_(chart_width_px, user_filters, kwargs) {
				debug_helper(arguments, DEBUG);

				const reports_with_features_path_match = TX_API_get_reports_with_features_path_match(user_filters, kwargs)
        let agregations = TX_API_prepare_time_windows_agregations(chart_width_px, user_filters, kwargs);
        let agregation_result = agregations.agregation_result;

        /*
        console.log("first: ", new Date(reports_with_features_path_match[0].date_time));
        console.log("last: ", new Date(reports_with_features_path_match[reports_with_features_path_match.length - 1].date_time));
        console.log("first aggr: ", new Date(agregation_result[0]));
        console.log("last aggr: ", new Date(agregation_result[agregation_result.length - 1]));
        */
        let stats = [];
				let position_in_reports = 0; // to continue from this, not from the beginning again
				for (let i in agregation_result) {
          stats.push(0); // create next step
          let date = agregation_result[i];
          for (let j = position_in_reports; j < reports_with_features_path_match.length; j++) {
						let r = reports_with_features_path_match[j];
						if (r.date_time <= date) { // this report is in this time frame, so collect it
							stats[i] += 1;
							position_in_reports += 1;
						}
						else {
							break; // this report from next frame, so go for next time frame
						}
					}
				}

        const step = TX_API_get_optimal_time_step_for_agregations(chart_width_px, agregations.ms_in_1_px);
        let aggr_dates = [];
        let mins = [];
        let maxes = [];
        let medians = [];
        for (let i = 0; i < stats.length / step; i++) {
          let pack = stats.slice(i * step, i * step + step);
          const pack_stats = TX_API_get_stats_for_list(pack);

          mins.push(pack_stats.min);
          maxes.push(pack_stats.max);
          medians.push(pack_stats.median);
          aggr_dates.push(agregation_result[i * step]);
        }

        //console.table(TX_API_get_stats_for_list(stats))

        let labels = [];
        let data = [];
				for (let i in aggr_dates) {
					labels.push(parseInt(aggr_dates[i]));
				}
        data.push(mins);
        data.push(medians);
        data.push(maxes);

				let displayed_time_range = agregations.displayed_time_range;
				let display_unit_and_step = TX_API_get_display_unit_and_step(displayed_time_range, chart_width_px);

				return Object.assign({}, {'labels': labels, 'data': data, 'ms_in_pixel': agregations.ms_in_1_px}, display_unit_and_step);
			}
	////////////////////// END OF OUR ANALYTICS TX API /////////////////////////


	////////////////////// CLIENT EMULATORS /////////////////////////
      const DTU_TAG = "dtu";
      const DTU_ELEMENTS_TO_TRACK = document.querySelectorAll('[data-' + DTU_TAG + ']');

			function EMULATOR_get_random_int_between(min, max) { // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random
			  return Math.floor(Math.random() * (max - min) + min);
			}

			function EMULATOR_get_random_item_from_list(list) { // https://stackoverflow.com/questions/5915096/get-a-random-item-from-a-javascript-array
				debug_helper(arguments, DEBUG);
			  return list[EMULATOR_get_random_item_from_number(list.length)];
			}
			function EMULATOR_get_random_item_from_number(number) {
				debug_helper(arguments, DEBUG);
				return Math.floor(Math.random()*number);
			}

			const max_number_of_days_ago = 50;
			const max_time_ago = Date.now() - 86400 * 1000 * max_number_of_days_ago;
			var emulated_time = max_time_ago;

			function EMULATOR_get_random_date(random_time_frame, random_time_unit) {
				debug_helper(arguments, DEBUG);
				let time_frame = EMULATOR_get_random_item_from_number(random_time_frame);
				let new_emulated_time = emulated_time + time_frame * random_time_unit;
				emulated_time = new_emulated_time;
				return new_emulated_time;
			}

      const elements = [];
      for (let i in DTU_ELEMENTS_TO_TRACK) {
        const element = DTU_ELEMENTS_TO_TRACK[i];
        if (element.dataset)
          elements.push(element.dataset[DTU_TAG]);
      }

      const topic_dropdown = document.getElementById('drpd:topic');
      const topics = [
          //null,  // null - for 'default' by back-end
        ];
      for (let i in topic_dropdown.options) {
        const topic = topic_dropdown.options[i].value;
        topics.push(topic);
      }

			function EMULATOR_make_report(topic, random_time_unit) {
				debug_helper(arguments, DEBUG);

				let c = {};
				c.ctag = ctag;
				c.topic = topic;
        const random_time_frame = 15;
				c.date_time = EMULATOR_get_random_date(random_time_frame, random_time_unit);
				c.feature = EMULATOR_get_random_item_from_list(elements);
				return c;
			}

      function generate_fake_data() {
        for (let i in topics) {
          const topic = topics[i];
          if (topic == 'auto-generated (heavy)') {
            emulated_time = max_time_ago;
            let t = max_time_ago;
            while (t < Date.now()) {
              let c = EMULATOR_make_report(topic, UNITS_NAMES_VALUES.second);
              t = c.date_time;
              CLIENT_SDK_send_to_telemetry_api(c);
            }
          }
          else if (topic == 'auto-generated (light)') {
            emulated_time = max_time_ago;
            let t = max_time_ago;
            while (t < Date.now()) {
              let c = EMULATOR_make_report(topic, UNITS_NAMES_VALUES.minute);
              t = c.date_time;
              CLIENT_SDK_send_to_telemetry_api(c);
            }
          }
        }
      }
      
      generate_fake_data();
	//////////////////// CLIENT EMULATORS END ///////////////////////

	////////////////////// CLIENT'S SDK /////////////////////////
			// ENV-DEPENDANT PARAMS
			//var c = {};
			//c.ctag = "ABC";
			//c.category = "web";  // to be used here without get from elements
			//c.topic = "default";
			//c.app_name = "Analytics";

			// ENV-INDEPENDANT PARAMS
			//c.app_version = "4.26.1";
			//c.release = "0.1.0.0";

			// SDK APP FUNCTIONS
			const excluded_events = "mousedown mouseup mousemove mouseover mouseout mousewheel";
			const events = "click focus blur keydown change dblclick keydown keyup keypress textInput touchstart touchmove touchend touchcancel resize scroll zoom select change submit reset".split(" ");


			function CLIENT_SDK_send_to_telemetry_api(report) {
				debug_helper(arguments, DEBUG);
				//console.log(report)
				jr = JSON.stringify(report);
				RX_API_submint_report(jr); // send emulation
			}

      const CLIENT_SDK_topic = "real usage";
      const CLIENT_SDK_ctag = "ABCD";
      
      //const DTU_TAG = "dtu";
			//const DTU_ELEMENTS_TO_TRACK = document.querySelectorAll('[data-dtu]');

			for (let i = 0; i < DTU_ELEMENTS_TO_TRACK.length; i++) {
				var element = DTU_ELEMENTS_TO_TRACK[i];

        if (element.type == "select-one") { // dropdown
          element.addEventListener("change", function(e) {
            var clicked = this.dataset[DTU_TAG];
            var value = this.value;

            const c = CLIENT_SDK_prepare_data_before_send(clicked, value);
            console.log(c);
            CLIENT_SDK_send_to_telemetry_api(c);
          }, false);
        }
        else if (element.type == "datetime-local") {
          element.addEventListener("change", function(e) {
            var clicked = this.dataset[DTU_TAG];
            var value = this.value;
            //ANALYTICS_PORTAL_SDK_remove_all_active_filter_class_from_time_shortcuts(); // has to be separate listener, just done here for fast try
            const c = CLIENT_SDK_prepare_data_before_send(clicked, value);
            console.log(c);
            CLIENT_SDK_send_to_telemetry_api(c);
          }, false);
        }
        else { // some link or any clickable thing
          //console.log(element.type)
          element.addEventListener("click", function(e) {
            const clicked = 'link';
            const value = this.dataset[DTU_TAG];

            const c = CLIENT_SDK_prepare_data_before_send(clicked, value);
            //console.log(c);
            CLIENT_SDK_send_to_telemetry_api(c);
          }, false);
        }
			}

      function CLIENT_SDK_prepare_data_before_send(clicked, value) {
        let c = {};
        c.ctag = CLIENT_SDK_ctag;
        c.topic = CLIENT_SDK_topic;
        c.feature = clicked;
        c.value = value;
        c.date_time = Date.now();
        return c;
      }
	////////////////////// END OF CLIENT'S SDK /////////////////////////


	/////////////// ANALYTICS HTML /////////////////

			ANALYTICS_PORTAL_SDK_start();

	/////////////// END OF ANALYTICS HTML /////////


	///////////////////////////////// DEBUG HELP ///////////////////////////////
			var DEBUG = false;
			function debug_helper(args, is_debug) {
				if (!is_debug)
					return;

				console.log(args.callee.name);
			}
	///////////////////////////////// END OF DEBUG HELP ///////////////////////
		</script>
    <script src="one.js"></script>
    <script src="two.js"></script>
	</body>
</html>